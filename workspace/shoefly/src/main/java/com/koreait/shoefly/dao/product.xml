<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.koreait.shoefly.dao.ProductDAO">

	<!-- 전체 상품 갯수 조회 -->
	<select id="countProduct" resultType="int">
		SELECT COUNT(*)
		  FROM PRODUCT
	</select>
	
	<!-- 전체 상품 목록 조회 -->
	<select id="selectAllList" resultType="com.koreait.shoefly.dto.Product">
		SELECT D.PRODUCT_NO AS PRODUCTNO, D.PRODUCT_NAME AS PRODUCTNAME, D.PRICE, D.BRAND, D.IMAGE
		  FROM (
		  		SELECT ROWNUM AS RN, C.PRODUCT_NO, C.PRODUCT_NAME, C.PRICE, C.BRAND, C.IMAGE
			      FROM ( SELECT DISTINCT B.PRODUCT_NO, B.PRODUCT_NAME, B.PRICE, B.BRAND, B.IMAGE
			   		       FROM PRODUCT_DETAIL A INNER JOIN PRODUCT B
			                 ON A.PRODUCT_NAME = B.PRODUCT_NAME ) C ) D
		 WHERE D.RN BETWEEN #{beginRecord} AND #{endRecord}
	</select>
	
	<!-- 조건 상품 갯수 조회 -->
	<select id="countConditionProduct" resultType="int">
		SELECT COUNT(*)
		  FROM (SELECT DISTINCT B.PRODUCT_NO, B.PRODUCT_NAME, B.PRICE, B.BRAND, B.IMAGE
		   		  FROM PRODUCT_DETAIL A INNER JOIN PRODUCT B
		    		ON A.PRODUCT_NAME = B.PRODUCT_NAME
			   <where>
					<if test="productName != null or productName != ''.toString">
							UPPER(B.PRODUCT_NAME) LIKE '%' || UPPER(#{productName}) || '%'
			  		</if>
			  		<if test="true">
							AND B.BRAND IN (${brandsArray})
				      	    AND A.PRODUCT_SIZE IN (${sizesArray})
			  				AND B.PRICE BETWEEN ${minPrice} AND ${maxPrice}
			  		</if>
			   </where>
				)
	</select>
	
	<!-- 상품명, 사이즈, 브랜드, 가격 조회 -->
	<select id="selectCondition" resultType="com.koreait.shoefly.dto.Product">
		 SELECT D.PRODUCT_NO AS PRODUCTNO, D.PRODUCT_NAME AS PRODUCTNAME, D.PRICE, D.BRAND, D.IMAGE
		   FROM (
		   		 SELECT ROWNUM AS RN, C.PRODUCT_NO, C.PRODUCT_NAME, C.PRICE, C.BRAND, C.IMAGE
		   		   FROM ( SELECT DISTINCT B.PRODUCT_NO, B.PRODUCT_NAME, B.PRICE, B.BRAND, B.IMAGE
		   				    FROM PRODUCT_DETAIL A INNER JOIN PRODUCT B
		    				  ON A.PRODUCT_NAME = B.PRODUCT_NAME 				  
		  				 <where>
		  				 <if test="productName != null or productName != ''.toString">
 								 UPPER(B.PRODUCT_NAME) LIKE '%' || UPPER(#{productName}) || '%'
	 	   		   		 </if>
	 	   		   		 <if test="true">
		  						 AND B.BRAND IN (${brandsArray})
		  		  				 AND A.PRODUCT_SIZE IN (${sizesArray})
	 	   		   				 AND B.PRICE BETWEEN ${minPrice} AND ${maxPrice}
	 	   		   		 </if>
	 	   		   		 </where>
	 	   		   			) C ) D
			WHERE D.RN BETWEEN #{beginRecord} AND #{endRecord}
	</select>
	
	<!-- PRODUCT_NO별로 조회 -->
	<select id="selectProductByProductNo" resultType="com.koreait.shoefly.dto.Product">
		SELECT DISTINCT A.PRODUCT_NO AS productNo, A.PRODUCT_NAME AS productName, A.BRAND, A.PRICE, A.IMAGE, A.STATE
		  FROM PRODUCT A INNER JOIN PRODUCT_DETAIL B
            ON A.PRODUCT_NAME = B.PRODUCT_NAME
		 WHERE PRODUCT_NO = #{param1}
	</select>
	
	<!-- 비로그인시/ size와 제품명으로 즉시구매가 조회 -->
	<select id="selectBuyPriceBySizeNoId" resultType="long">
		SELECT MIN(A.PRICE) 
		  FROM PRODUCT_SELL A INNER JOIN PRODUCT_DETAIL B
		    ON A.PRODUCT_DETAIL_NO = B.PRODUCT_DETAIL_NO
		 WHERE B.PRODUCT_SIZE = ${param1}
		   AND B.PRODUCT_NAME = #{param2}
           AND A.STATE = 1
	</select>
	
	<!-- 비로그인시/ size와 제품명으로 즉시판매가 조회 -->
	<select id="selectSellPriceBySizeNoId" resultType="long">
		SELECT MAX(A.PRICE) 
		  FROM PRODUCT_BUY A INNER JOIN PRODUCT_DETAIL B
		    ON A.PRODUCT_DETAIL_NO = B.PRODUCT_DETAIL_NO
		 WHERE B.PRODUCT_SIZE = ${param1}
		   AND B.PRODUCT_NAME = #{param2}
		   AND A.STATE = 0
	</select>
	
	<!-- 로그인시/ size와 제품명으로 즉시구매가 조회 -->
	<select id="selectBuyPriceBySize" resultType="long">
		SELECT MIN(A.PRICE) 
		  FROM PRODUCT_SELL A INNER JOIN PRODUCT_DETAIL B
		    ON A.PRODUCT_DETAIL_NO = B.PRODUCT_DETAIL_NO
		 WHERE B.PRODUCT_SIZE = ${param1}
		   AND B.PRODUCT_NAME = #{param2}
           AND A.STATE = 1
		   AND A.MEMBER_ID != #{param3}
	</select>
	
	<!-- 로그인시/ size와 제품명으로 즉시판매가 조회 -->
	<select id="selectSellPriceBySize" resultType="long">
		SELECT MAX(A.PRICE) 
		  FROM PRODUCT_BUY A INNER JOIN PRODUCT_DETAIL B
		    ON A.PRODUCT_DETAIL_NO = B.PRODUCT_DETAIL_NO
		 WHERE B.PRODUCT_SIZE = ${param1}
		   AND B.PRODUCT_NAME = #{param2}
		   AND A.STATE = 0
		   AND A.MEMBER_ID != #{param3}
	</select>
	
	<!-- 구매 신청서 이동시 product 조회 -->
	<select id="buyApplication" resultType="com.koreait.shoefly.dto.Product">
		SELECT A.PRODUCT_NAME AS PRODUCTNAME, A.BRAND, A.PRICE, A.IMAGE
		  FROM PRODUCT A INNER JOIN PRODUCT_DETAIL B
		    ON A.PRODUCT_NAME = B.PRODUCT_NAME
		 WHERE A.PRODUCT_NAME = #{param1}
		   AND B.PRODUCT_SIZE = ${param2}
	</select>
	

	<!-- 현재 구매희망가 중 최고가 -->
	<select id="hightPriceInBuy" resultType="long">
		SELECT MAX(A.PRICE)
		  FROM PRODUCT_BUY A INNER JOIN PRODUCT_DETAIL B
		    ON A.PRODUCT_DETAIL_NO = B.PRODUCT_DETAIL_NO
		 WHERE B.PRODUCT_DETAIL_NO = (
                                      SELECT D.PRODUCT_DETAIL_NO
                                        FROM PRODUCT C INNER JOIN PRODUCT_DETAIL D
                                          ON C.PRODUCT_NAME = D.PRODUCT_NAME
                                       WHERE D.PRODUCT_NAME = #{param1}
                                         AND D.PRODUCT_SIZE = ${param2}
									  )
            AND STATE = 0
	</select>
	
	<!-- 현재 판매 희망가 중 최저가 -->
	<select id="lowPriceInSell" resultType="long">
		SELECT MIN(A.PRICE)
		  FROM PRODUCT_SELL A INNER JOIN PRODUCT_DETAIL B
		    ON A.PRODUCT_DETAIL_NO = B.PRODUCT_DETAIL_NO
		 WHERE B.PRODUCT_DETAIL_NO = (
                                      SELECT D.PRODUCT_DETAIL_NO
                                        FROM PRODUCT C INNER JOIN PRODUCT_DETAIL D
                                          ON C.PRODUCT_NAME = D.PRODUCT_NAME
                                       WHERE D.PRODUCT_NAME = #{param1}
                                         AND D.PRODUCT_SIZE = ${param2}
									  )
            AND STATE = 1
	</select>
	
	<!-- 로그인유저의 배송지 조회-->
	<select id="selectMemberAddr" resultType="com.koreait.shoefly.dto.MemberAddress">
		SELECT B.MEMBER_ADDRESS_NO AS memberAddressNo, B.NAME, B.ADDR1, B.ADDR2
		  FROM MEMBER A INNER JOIN MEMBER_ADDRESS B 
		    ON A.MEMBER_NO = B.MEMBER_NO
		 WHERE A.MEMBER_NO = (SELECT MEMBER_NO
		 					    FROM MEMBER
		 					   WHERE MEMBER_ID = #{param1}
		 				     )
		   AND B.STATE = 0
	</select>
	
	<!-- 현재 MEMBER_ADDRESS TABLE에서 MEMBER_ADDRESS_NO중 최대값 찾기 -->
	<!-- 값이 0이면 신규등록한 주소라는것, 0이 아니면 기존주소라는 것 -->
	<select id="maxMemberAddressNo" resultType="long">
		SELECT MAX(MEMBER_ADDRESS_NO) AS maxMemberAddressNo
		  FROM MEMBER_ADDRESS 
		 WHERE STATE = 0
	</select>
	
	<!-- 새로운 주소 등록 -->
	<insert id="insertNewAddress">
		INSERT INTO MEMBER_ADDRESS
		VALUES (
				MEMBER_ADDRESS_SEQ.NEXTVAL,
				(SELECT MEMBER_NO
				   FROM MEMBER
				  WHERE MEMBER_ID = #{param1}
				),
				#{param2},
				#{param3},
				#{param4},
				0
				)
	</insert>
	
	<!-- 구매 신청서 작성 -->
	<insert id="insertBuyApplication">
		INSERT INTO PRODUCT_BUY
		VALUES (
				PRODUCT_BUY_SEQ.NEXTVAL,
			    #{param1},
			    (SELECT PRODUCT_DETAIL_NO 
			       FROM PRODUCT_DETAIL
			      WHERE PRODUCT_NAME = #{param2}
			        AND PRODUCT_SIZE = ${param3}
			    ),
			    ${param4},
				${param5},
			    SYSDATE,
			    NULL,
			    0 
				)
	</insert>
	
	<!-- 판매 신청서 작성 -->
	<insert id="insertSellApplication">
		INSERT INTO PRODUCT_SELL
		VALUES (
				PRODUCT_SELL_SEQ.NEXTVAL,
			    #{param1},
			    (SELECT PRODUCT_DETAIL_NO 
			       FROM PRODUCT_DETAIL
			      WHERE PRODUCT_NAME = #{param2}
			        AND PRODUCT_SIZE = ${param3}
			    ),
			    ${param4},
				${param5},
			    SYSDATE,
			    NULL,
			    NULL,
			    0 
				)
	</insert>
</mapper>