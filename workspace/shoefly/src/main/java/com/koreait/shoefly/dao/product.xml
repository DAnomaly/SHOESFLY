<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.koreait.shoefly.dao.ProductDAO">

	<!-- 전체 상품 갯수 조회 -->
	<select id="countProduct" resultType="int">
		SELECT COUNT(*)
		  FROM PRODUCT
	</select>
	
	<!-- 전체 상품 목록 조회 -->
	<select id="selectAllList" resultType="com.koreait.shoefly.dto.Product">
		SELECT D.PRODUCT_NO AS PRODUCTNO, D.PRODUCT_NAME AS PRODUCTNAME, D.PRICE, D.BRAND, D.IMAGE
		  FROM (
		  		SELECT ROWNUM AS RN, C.PRODUCT_NO, C.PRODUCT_NAME, C.PRICE, C.BRAND, C.IMAGE
			      FROM ( SELECT DISTINCT B.PRODUCT_NO, B.PRODUCT_NAME, B.PRICE, B.BRAND, B.IMAGE
			   		       FROM PRODUCT_DETAIL A INNER JOIN PRODUCT B
			                 ON A.PRODUCT_NAME = B.PRODUCT_NAME ) C ) D
		 WHERE D.RN BETWEEN #{beginRecord} AND #{endRecord}
	</select>
	
	<!-- 조건 상품 갯수 조회 -->
	<select id="countConditionProduct" resultType="int">
		SELECT COUNT(*)
		  FROM (SELECT DISTINCT B.PRODUCT_NO, B.PRODUCT_NAME, B.PRICE, B.BRAND, B.IMAGE
		   		  FROM PRODUCT_DETAIL A INNER JOIN PRODUCT B
		    		ON A.PRODUCT_NAME = B.PRODUCT_NAME
		<where>
		<if test="productName != null or productName != ''.toString">
					   UPPER(B.PRODUCT_NAME) LIKE '%' || UPPER(#{productName}) || '%'
  		</if>
  		<if test="true">
				   AND B.BRAND IN (${brandsArray})
	      	       AND A.PRODUCT_SIZE IN (${sizesArray})
  				   AND B.PRICE BETWEEN ${minPrice} AND ${maxPrice}
  		</if>
		</where>
				)
	</select>
	
	<!-- 상품명, 사이즈, 브랜드, 가격 조회 -->
	<select id="selectCondition" resultType="com.koreait.shoefly.dto.Product">
		 SELECT D.PRODUCT_NO AS PRODUCTNO, D.PRODUCT_NAME AS PRODUCTNAME, D.PRICE, D.BRAND, D.IMAGE
		   FROM (
		   		 SELECT ROWNUM AS RN, C.PRODUCT_NO, C.PRODUCT_NAME, C.PRICE, C.BRAND, C.IMAGE
		   		   FROM ( SELECT DISTINCT B.PRODUCT_NO, B.PRODUCT_NAME, B.PRICE, B.BRAND, B.IMAGE
		   				    FROM PRODUCT_DETAIL A INNER JOIN PRODUCT B
		    				  ON A.PRODUCT_NAME = B.PRODUCT_NAME 				  
		  				<where>
		  				<if test="productName != null or productName != ''.toString">
 								 UPPER(B.PRODUCT_NAME) LIKE '%' || UPPER(#{productName}) || '%'
	 	   		   		</if>
	 	   		   		<if test="true">
		  					AND B.BRAND IN (${brandsArray})
		  		  			AND A.PRODUCT_SIZE IN (${sizesArray})
	 	   		   			AND B.PRICE BETWEEN ${minPrice} AND ${maxPrice}
	 	   		   		</if>
	 	   		   		</where>
	 	   		   			) C ) D
			WHERE D.RN BETWEEN #{beginRecord} AND #{endRecord}
	</select>
	
	<!-- PRODUCT_NO별로 조회 -->
	<select id="selectProductByProductNo" resultType="com.koreait.shoefly.dto.Product">
		SELECT DISTINCT A.PRODUCT_NO AS productNo, A.PRODUCT_NAME AS productName, A.BRAND, A.PRICE, A.IMAGE, A.STATE
		  FROM PRODUCT A INNER JOIN PRODUCT_DETAIL B
            ON A.PRODUCT_NAME = B.PRODUCT_NAME
		 WHERE PRODUCT_NO = #{param1}
	</select>
	
	<!-- size와 제품명으로 즉시구매가 조회 -->
	<select id="selectBuyPriceBySize" resultType="com.koreait.shoefly.dto.ProductSell">
		SELECT MIN(A.PRICE) 
		  FROM PRODUCT_SELL A INNER JOIN PRODUCT_DETAIL B
		    ON A.PRODUCT_DETAIL_NO = B.PRODUCT_DETAIL_NO
		 WHERE B.PRODUCT_SIZE = ${param1}
		   AND B.PRODUCT_NAME = #{param2}
	</select>
	
	<!-- size와 제품명으로 즉시판매가 조회 -->
	<select id="selectSellPriceBySize" resultType="com.koreait.shoefly.dto.ProductBuy">
		SELECT MAX(A.PRICE) 
		  FROM PRODUCT_BUY A INNER JOIN PRODUCT_DETAIL B
		    ON A.PRODUCT_DETAIL_NO = B.PRODUCT_DETAIL_NO
		 WHERE B.PRODUCT_SIZE = ${param1}
		   AND B.PRODUCT_NAME = #{param2}
	</select>
</mapper>